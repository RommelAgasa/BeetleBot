#include <WString.h>
#include <HardwareSerial.h>
#include <Servo.h>

String G_Bluetooth_value;
volatile int BLE_Change_SPEED;
int maxSpeed = 60;
int speedStep = 10; 

String lastMovementCommand = "S"; 

// Gear system: 1 = Normal, 2 = Double Speed, R = Reverse
String currentGear = "1";

Servo myServo;
int servoPin = 10;
int servoOpenAngle = 90;   // Angle for open position
int servoCloseAngle = 0;    // Angle for close position

float mapfloat(float x, float in_min, float in_max, float out_min, float out_max)
{
  return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
}

void executeMovement(String command, float value) {
  // Calculate base speed
  int baseSpeed = (BLE_Change_SPEED / 10) * 22.5;
  int baseHalfSpeed = (BLE_Change_SPEED / 10) * 11.25;
  int turnSpeed = (maxSpeed / 10) * 11.25;
  
  // Apply gear multiplier
  int speed, halfSpeed;
  if (currentGear == "2") {
    // Gear 2: Double speed
    speed = min(baseSpeed * 2, 255);
    halfSpeed = min(baseHalfSpeed * 2, 255);
  } else {
    // Gear 1 and Reverse: Normal speed
    speed = baseSpeed;
    halfSpeed = baseHalfSpeed;
  }
  
  // In Reverse gear, swap F<->B and diagonal commands
  String actualCommand = command;
  if (currentGear == "R") {
    if (command == "F") actualCommand = "B";
    else if (command == "B") actualCommand = "F";
    else if (command == "FL") actualCommand = "BL";
    else if (command == "FR") actualCommand = "BR";
    else if (command == "BL") actualCommand = "FL";
    else if (command == "BR") actualCommand = "FR";
  }
  
  // Execute movement with same pin connections
  if (actualCommand == "F") {
    digitalWrite(2, HIGH);
    analogWrite(5, speed);
    digitalWrite(4, LOW);
    analogWrite(6, speed);
  } else if (actualCommand == "B") {
    digitalWrite(2, LOW);
    analogWrite(5, speed);
    digitalWrite(4, HIGH);
    analogWrite(6, speed);
  } else if (actualCommand == "L") {
    digitalWrite(2, LOW);
    analogWrite(5, turnSpeed);
    digitalWrite(4, LOW);
    analogWrite(6, turnSpeed);
  } else if (actualCommand == "R") {
    digitalWrite(2, HIGH);
    analogWrite(5, turnSpeed);
    digitalWrite(4, HIGH);
    analogWrite(6, turnSpeed);
  } else if (actualCommand == "FL") {
    digitalWrite(2, HIGH);
    analogWrite(5, halfSpeed); 
    digitalWrite(4, LOW);
    analogWrite(6, speed); 
  } else if (actualCommand == "FR") {
    digitalWrite(2, HIGH);
    analogWrite(5, speed); 
    digitalWrite(4, LOW);
    analogWrite(6, halfSpeed); 
  } else if (actualCommand == "BL") {
    digitalWrite(2, LOW);
    analogWrite(5, halfSpeed); 
    digitalWrite(4, HIGH);
    analogWrite(6, speed); 
  } else if (actualCommand == "BR") {
    digitalWrite(2, LOW);
    analogWrite(5, speed); 
    digitalWrite(4, HIGH);
    analogWrite(6, halfSpeed); 
  } else if (actualCommand == "S") {
    digitalWrite(2, LOW);
    analogWrite(5, 0);
    digitalWrite(4, LOW);
    analogWrite(6, 0);
  } 
}

// Smooth servo control: adjustable open and close speeds
void controlServo(int targetAngle) {
  int currentAngle = myServo.read();
  
  if (targetAngle == servoOpenAngle) {
    // Opening: smooth movement to 90 degrees
    for (int pos = currentAngle; pos <= servoOpenAngle; pos++) {
      myServo.write(pos);
      delay(8); // Adjust delay for opening speed (higher = slower, try 5-20)
    }
    Serial.println("Servo Opened");
  } else if (targetAngle == servoCloseAngle) {
    // Closing: smooth and slow
    for (int pos = currentAngle; pos >= servoCloseAngle; pos--) {
      myServo.write(pos);
      delay(8); // Adjust delay for closing speed (higher = slower)
    }
    Serial.println("Servo Closed");
  }
}

void setup(){
  Serial.begin(9600);
  G_Bluetooth_value = "";
  BLE_Change_SPEED = 0;
  
  // Same pin configuration
  pinMode(2, OUTPUT);
  pinMode(5, OUTPUT);
  pinMode(4, OUTPUT);
  pinMode(6, OUTPUT);
  
  // Initialize servo
  myServo.attach(servoPin);
  myServo.write(servoCloseAngle); // Start at closed position
  
  Serial.println("System Ready - Gear 1");
}

void loop(){
  while (Serial.available() > 0) {
    G_Bluetooth_value = G_Bluetooth_value + ((char)(Serial.read()));
    delay(2);
  }
  if (G_Bluetooth_value.length() > 0) {
    String cmd = G_Bluetooth_value;
    float value = (BLE_Change_SPEED / 10) * 15;

    // Check for BLE settings commands (matches app's MAX: command)
    if (cmd.startsWith("MAX:")) {
      int val = cmd.substring(4).toInt();
      if (val >= 0 && val <= 255) maxSpeed = val;
      G_Bluetooth_value = "";
      return;
    } else if (cmd.startsWith("TURN:")) {
      int val = cmd.substring(5).toInt();
      if (val >= 0 && val <= 100) maxSpeed = val;
      G_Bluetooth_value = "";
      return;
    } else if (cmd.startsWith("STEP:")) {
      int val = cmd.substring(5).toInt();
      if (val > 0 && val <= 100) speedStep = val;
      G_Bluetooth_value = "";
      return;
    }

    // Check for movement commands (F, B, L, R, S - matches app)
    String movementCmd = "";
    if (cmd.startsWith("FL") || cmd.startsWith("FR") || cmd.startsWith("BL") || cmd.startsWith("BR")) {
      movementCmd = cmd.substring(0, 2);
    } else if (cmd.startsWith("F") || cmd.startsWith("B") || cmd.startsWith("L") || cmd.startsWith("R") || cmd.startsWith("S")) {
      movementCmd = cmd.substring(0, 1);
    }

    if (movementCmd.length() > 0) {
      lastMovementCommand = movementCmd;
      executeMovement(movementCmd, value);
      G_Bluetooth_value = "";
      return;
    }

    // Check for servo commands (O for Open, C for Close - matches app)
    if (cmd == "O" || cmd.startsWith("OPEN")) {
      controlServo(servoOpenAngle);
      G_Bluetooth_value = "";
      return;
    } else if (cmd == "C" || cmd.startsWith("CLOSE")) {
      controlServo(servoCloseAngle);
      G_Bluetooth_value = "";
      return;
    }

    // Process single character commands
    char command = cmd.charAt(0);
    switch (command) {
      case '+': // Increase speed (matches app's speed increment)
        BLE_Change_SPEED += speedStep;
        if (BLE_Change_SPEED > maxSpeed) BLE_Change_SPEED = maxSpeed;
        Serial.print("Speed: ");
        Serial.print(BLE_Change_SPEED);
        Serial.print(" | Gear: ");
        Serial.println(currentGear);
        executeMovement(lastMovementCommand, (BLE_Change_SPEED / 10) * 15);
        break;
        
      case '-': // Decrease speed
        BLE_Change_SPEED -= speedStep;
        if (BLE_Change_SPEED < 0) BLE_Change_SPEED = 0;
        Serial.print("Speed: ");
        Serial.print(BLE_Change_SPEED);
        Serial.print(" | Gear: ");
        Serial.println(currentGear);
        executeMovement(lastMovementCommand, (BLE_Change_SPEED / 10) * 15);
        break;
        
      case '/': // Reset speed to 0 (matches app's reset command)
        BLE_Change_SPEED = 0;
        Serial.print("Speed: ");
        Serial.print(BLE_Change_SPEED);
        Serial.print(" | Gear: ");
        Serial.println(currentGear);
        executeMovement(lastMovementCommand, (BLE_Change_SPEED / 10) * 15);
        break;
        
      case '1': // Gear 1 - Normal Speed (matches app's gear system)
        currentGear = "1";
        Serial.println("Gear 1 - Normal Speed");
        break;
        
      case '2': // Gear 2 - Double Speed (matches app's gear system)
        currentGear = "2";
        Serial.println("Gear 2 - Double Speed");
        break;
        
      default:
        Serial.println("Invalid Command");
        break;
    }
    
    G_Bluetooth_value = "";
  }
}